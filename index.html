<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Tela – Presentazione con Immagini + Connettori Curvi</title>
  <style>
    :root { --bg:#0f1115; --panel:#161a22; --txt:#e9eef7; --muted:#9aa6b2; --accent:#7aa2ff; }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    #hud{
      position:fixed; inset:12px auto auto 12px; z-index:10;
      background:rgba(22,26,34,.88); backdrop-filter: blur(10px);
      border:1px solid rgba(255,255,255,.08); border-radius:14px;
      padding:10px 12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    #hud button{
      background:transparent; color:var(--txt); border:1px solid rgba(255,255,255,.16);
      padding:8px 10px; border-radius:12px; cursor:pointer;
    }
    #hud button:hover{ border-color:rgba(255,255,255,.32); }
    #hud button.active{ border-color:rgba(122,162,255,.7); box-shadow:0 0 0 3px rgba(122,162,255,.12) inset; }
    #hud .info{ font-size:12px; color:var(--muted); white-space:nowrap; }

    #viewport{ position:fixed; inset:0; overflow:hidden; touch-action:none; }
    #world{ position:absolute; left:50%; top:50%; transform-origin:0 0; }

    /* SVG layer */
    #linksSvg{ position:absolute; left:0; top:0; overflow:visible; pointer-events:auto; }

    .node{
      position:absolute;
      min-width:190px; max-width:380px;
      background:rgba(22,26,34,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      padding:12px 14px;
      box-shadow:0 16px 40px rgba(0,0,0,.45);
      cursor:grab;
      user-select:none;
    }
    .node:active{ cursor:grabbing; }
    .node h3{ margin:0 0 6px 0; font-size:14px; letter-spacing:.2px; }
    .node p{ margin:0; font-size:13px; color:var(--muted); line-height:1.3; }
    .node .tag{ display:inline-block; margin-top:8px; font-size:11px; color:#cfe0ff; background:rgba(122,162,255,.12); border:1px solid rgba(122,162,255,.25); padding:3px 8px; border-radius:999px; }

    /* Image node */
    .node.image{
      padding:10px;
      min-width:220px;
      max-width:420px;
    }
    .node.image .thumb{
      width:100%;
      border-radius:14px;
      display:block;
      border:1px solid rgba(255,255,255,.10);
      background:#0b0d12;
    }
    .node.image .caption{
      margin:8px 4px 0 4px;
      font-size:12px;
      color:var(--muted);
    }

    /* SVG styles */
    .linkPath{ fill:none; stroke:rgba(122,162,255,.9); stroke-width:3; stroke-linecap:round; stroke-linejoin:round; pointer-events:stroke; }
    .linkPath.hit{ stroke-width:14; stroke:rgba(0,0,0,0); }
    .handle{ cursor:grab; fill:rgba(122,162,255,.95); stroke:rgba(255,255,255,.6); stroke-width:1; }
    .handle:active{ cursor:grabbing; }
    .handleLine{ stroke:rgba(255,255,255,.18); stroke-width:2; stroke-dasharray:6 6; }

    /* Modal */
    #modal{ position:fixed; inset:0; display:none; place-items:center; z-index:20; background:rgba(0,0,0,.55); }
    #modal .card{
      width:min(860px, calc(100% - 28px));
      background:var(--panel);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.55);
    }
    #modal .card header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    #modal .card header strong{ font-size:14px; }
    #modal .close{ border:1px solid rgba(255,255,255,.18); background:transparent; color:var(--txt); border-radius:12px; padding:6px 10px; cursor:pointer; }
    #modal .body{ color:var(--txt); font-size:14px; line-height:1.45; }
    #modal .body em{ color:var(--muted); font-style:normal; }
    #modal img.big{
      width:100%;
      height:auto;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:#0b0d12;
      display:block;
    }

    /* Hidden file input */
    #fileInput{ display:none; }
  </style>
</head>
<body>

  <div id="hud">
    <button id="btnHome" title="Torna alla vista iniziale">Home</button>
    <button id="btnConnect" title="Crea connettori: clicca due nodi">Connetti</button>
    <button id="btnAddText" title="Aggiungi nodo testo">+ Nodo</button>
    <button id="btnAddImgUrl" title="Aggiungi immagine da URL esterno">+ Immagine (URL)</button>
    <button id="btnAddImgUpload" title="Carica immagine locale (salvata nel browser)">+ Immagine (Upload)</button>
    <div class="info" id="info">Pan: trascina sfondo · Zoom: rotella/pinch · Doppio click nodo: focus</div>
  </div>

  <input id="fileInput" type="file" accept="image/*" />

  <div id="viewport">
    <div id="world">
      <svg id="linksSvg"></svg>
    </div>
  </div>

  <div id="modal">
    <div class="card">
      <header>
        <strong id="mTitle">Titolo</strong>
        <button class="close" id="mClose">Chiudi</button>
      </header>
      <div class="body" id="mBody"></div>
    </div>
  </div>

<script>
(() => {
  const viewport = document.getElementById('viewport');
  const world = document.getElementById('world');
  const linksSvg = document.getElementById('linksSvg');
  const info = document.getElementById('info');
  const fileInput = document.getElementById('fileInput');

  // Camera
  let cam = { x: 0, y: 0, s: 1 };
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

  function applyCam() {
    world.style.transform = `translate(${cam.x}px, ${cam.y}px) scale(${cam.s})`;
    info.textContent =
      `zoom:${cam.s.toFixed(2)} · ${mode==='connect' ? 'MODALITÀ CONNETTI: clicca 2 nodi' : 'Pan: trascina sfondo'} · Zoom: rotella/pinch · Doppio click nodo: focus`;
  }

  function screenToWorld(px, py) {
    const rect = viewport.getBoundingClientRect();
    const sx = px - rect.left;
    const sy = py - rect.top;
    return { x: (sx - cam.x) / cam.s, y: (sy - cam.y) / cam.s };
  }

  function zoomAt(px, py, factor) {
    const before = screenToWorld(px, py);
    cam.s = clamp(cam.s * factor, 0.2, 4);
    const rect = viewport.getBoundingClientRect();
    const sx = px - rect.left;
    const sy = py - rect.top;
    cam.x = sx - before.x * cam.s;
    cam.y = sy - before.y * cam.s;
    applyCam();
  }

  // Data
  const nodes = [
    { id:'n1', type:'text', x:-430, y:-200, w:260, h:120, title:'Pirandello', subtitle:'Maschere e fratture', body:'Qui puoi mettere testo, link, consegne.' },
    { id:'n2', type:'text', x: 160, y:-260, w:260, h:120, title:'Umorismo', subtitle:'Il sentimento del contrario', body:'Nodo 2.' },
    { id:'n3', type:'image', x:-40,  y: 190, w:320, h:220, title:'Immagine', caption:'Esempio immagine da URL', src:'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/Giacomo_Puccini_1908.jpg/640px-Giacomo_Puccini_1908.jpg' }
  ];

  const links = [
    { id:'l1', from:'n1', to:'n2', ctrl:{ x:-90, y:-380 } },
    { id:'l2', from:'n2', to:'n3', ctrl:{ x: 260, y: 40 } }
  ];

  // Modal
  const modal = document.getElementById('modal');
  const mTitle = document.getElementById('mTitle');
  const mBody  = document.getElementById('mBody');
  const mClose = document.getElementById('mClose');

  function openModalForNode(n) {
    mTitle.textContent = n.title || 'Nodo';
    if (n.type === 'image') {
      const safeSrc = escapeAttr(n.src || '');
      const cap = escapeHtml(n.caption || '');
      mBody.innerHTML = `
        <img class="big" src="${safeSrc}" alt="">
        <div style="margin-top:10px; color: var(--muted); font-size:13px;">${cap}</div>
        <div style="margin-top:10px; color: var(--muted); font-size:12px; word-break:break-all;">
          <em>Sorgente:</em> ${escapeHtml(n.src || '')}
        </div>
      `;
    } else {
      mBody.innerHTML = `<em>${escapeHtml(n.body || '')}</em>`;
    }
    modal.style.display = 'grid';
  }

  function closeModal(){ modal.style.display='none'; }
  mClose.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=> { if (e.target === modal) closeModal(); });

  // Render nodes
  function nodeCenter(n){
    const w = n.w || 260;
    const h = n.h || 120;
    return { x: n.x + w/2, y: n.y + h/2 };
  }

  function makeTextNode(n) {
    const el = document.createElement('div');
    el.className = 'node';
    el.dataset.id = n.id;
    el.style.left = `${n.x}px`;
    el.style.top  = `${n.y}px`;
    el.style.width = `${n.w || 260}px`;

    el.innerHTML = `
      <h3>${escapeHtml(n.title || 'Titolo')}</h3>
      <p>${escapeHtml(n.subtitle || '')}</p>
      <span class="tag">${mode==='connect' ? 'Seleziona' : 'Apri'}</span>
    `;
    return el;
  }

  function makeImageNode(n) {
    const el = document.createElement('div');
    el.className = 'node image';
    el.dataset.id = n.id;
    el.style.left = `${n.x}px`;
    el.style.top  = `${n.y}px`;
    el.style.width = `${n.w || 320}px`;

    const safeSrc = escapeAttr(n.src || '');
    el.innerHTML = `
      <img class="thumb" src="${safeSrc}" alt="">
      <div class="caption">${escapeHtml(n.caption || '')}</div>
      <span class="tag" style="margin-top:8px;">${mode==='connect' ? 'Seleziona' : 'Apri'}</span>
    `;

    // fallback: se l'immagine non carica (CORS/404), mostra un messaggio
    const img = el.querySelector('img');
    img.addEventListener('error', () => {
      img.replaceWith(Object.assign(document.createElement('div'), {
        style: 'padding:18px; border-radius:14px; border:1px dashed rgba(255,255,255,.22); color:var(--muted); font-size:12px;',
        textContent: 'Immagine non caricabile. Controlla URL o permessi del sito (hotlink/CORS).'
      }));
    });

    return el;
  }

  function attachNodeInteractions(el, n) {
    // Drag
    let dragging = false;
    let start = {x:0,y:0,nx:0,ny:0};
    el.addEventListener('pointerdown', (e) => {
      e.stopPropagation();
      el.setPointerCapture(e.pointerId);
      dragging = true;
      start = { x:e.clientX, y:e.clientY, nx:parseFloat(el.style.left), ny:parseFloat(el.style.top) };
    });
    el.addEventListener('pointermove', (e) => {
      if (!dragging) return;
      const dx = (e.clientX - start.x) / cam.s;
      const dy = (e.clientY - start.y) / cam.s;
      const nx = start.nx + dx;
      const ny = start.ny + dy;
      el.style.left = `${nx}px`;
      el.style.top  = `${ny}px`;
      n.x = nx; n.y = ny;
      renderLinks();
    });
    el.addEventListener('pointerup', () => dragging = false);

    // Click
    el.addEventListener('click', (e)=> {
      e.stopPropagation();
      if (mode === 'connect') pickNodeForLink(n.id);
      else openModalForNode(n);
    });

    // Dblclick focus
    el.addEventListener('dblclick', (e)=> {
      e.stopPropagation();
      focusNode(n);
    });
  }

  function renderNodes() {
    [...world.querySelectorAll('.node')].forEach(x => x.remove());
    nodes.forEach(n => {
      const el = (n.type === 'image') ? makeImageNode(n) : makeTextNode(n);
      attachNodeInteractions(el, n);
      world.appendChild(el);
    });
  }

  // Render links
  function setSvgSize() {
    linksSvg.setAttribute('width', '1');
    linksSvg.setAttribute('height', '1');
  }

  function linkEndpoints(link) {
    const a = nodes.find(n => n.id === link.from);
    const b = nodes.find(n => n.id === link.to);
    const ac = nodeCenter(a);
    const bc = nodeCenter(b);
    return { a: ac, b: bc };
  }

  function linkPathD(a, b, c) {
    return `M ${a.x} ${a.y} Q ${c.x} ${c.y} ${b.x} ${b.y}`;
  }

  function renderLinks() {
    linksSvg.innerHTML = '';
    setSvgSize();

    links.forEach(link => {
      const {a,b} = linkEndpoints(link);

      const guide = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      guide.setAttribute('d', `M ${a.x} ${a.y} L ${link.ctrl.x} ${link.ctrl.y} L ${b.x} ${b.y}`);
      guide.setAttribute('class', 'handleLine');
      linksSvg.appendChild(guide);

      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', linkPathD(a,b,link.ctrl));
      path.setAttribute('class', 'linkPath');
      linksSvg.appendChild(path);

      const hit = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      hit.setAttribute('d', linkPathD(a,b,link.ctrl));
      hit.setAttribute('class', 'linkPath hit');
      linksSvg.appendChild(hit);

      const handle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      handle.setAttribute('cx', link.ctrl.x);
      handle.setAttribute('cy', link.ctrl.y);
      handle.setAttribute('r', 8);
      handle.setAttribute('class', 'handle');
      linksSvg.appendChild(handle);

      // drag handle
      let dragging = false;
      handle.addEventListener('pointerdown', (e)=> {
        e.stopPropagation(); e.preventDefault();
        handle.setPointerCapture(e.pointerId);
        dragging = true;
      });
      handle.addEventListener('pointermove', (e)=> {
        if (!dragging) return;
        const p = screenToWorld(e.clientX, e.clientY);
        link.ctrl.x = p.x;
        link.ctrl.y = p.y;
        renderLinks();
      });
      handle.addEventListener('pointerup', ()=> dragging = false);
    });
  }

  // Focus
  function focusNode(n) {
    const targetZoom = 1.7;
    cam.s = targetZoom;
    const rect = viewport.getBoundingClientRect();
    const cx = rect.width / 2;
    const cy = rect.height / 2;
    const center = nodeCenter(n);
    cam.x = cx - center.x * cam.s;
    cam.y = cy - center.y * cam.s;
    applyCam();
  }

  function home() { cam = { x:0, y:0, s:1 }; applyCam(); }

  // Pan
  let panning = false;
  let panStart = {x:0,y:0,cx:0,cy:0};

  viewport.addEventListener('pointerdown', (e)=> {
    panning = true;
    viewport.setPointerCapture(e.pointerId);
    panStart = { x:e.clientX, y:e.clientY, cx:cam.x, cy:cam.y };
  });

  viewport.addEventListener('pointermove', (e)=> {
    if (!panning) return;
    cam.x = panStart.cx + (e.clientX - panStart.x);
    cam.y = panStart.cy + (e.clientY - panStart.y);
    applyCam();
  });

  viewport.addEventListener('pointerup', ()=> panning = false);

  // Zoom wheel
  viewport.addEventListener('wheel', (e)=> {
    e.preventDefault();
    const factor = e.deltaY < 0 ? 1.08 : 0.92;
    zoomAt(e.clientX, e.clientY, factor);
  }, { passive:false });

  // Pinch zoom minimale
  const lastPointers = new Map();
  let pinch = { active:false, id1:null, id2:null, d0:0, s0:1, mid:{x:0,y:0} };

  viewport.addEventListener('pointerdown', (e)=> {
    lastPointers.set(e.pointerId, {x:e.clientX,y:e.clientY});
    if (!pinch.id1) pinch.id1 = e.pointerId;
    else if (!pinch.id2) {
      pinch.id2 = e.pointerId;
      pinch.active = true;
      const p1 = lastPointers.get(pinch.id1);
      const p2 = lastPointers.get(pinch.id2);
      pinch.d0 = dist(p1,p2);
      pinch.s0 = cam.s;
      pinch.mid = { x:(p1.x+p2.x)/2, y:(p1.y+p2.y)/2 };
    }
  });

  viewport.addEventListener('pointermove', (e)=> {
    lastPointers.set(e.pointerId, {x:e.clientX,y:e.clientY});
    if (!pinch.active) return;
    if (!lastPointers.has(pinch.id1) || !lastPointers.has(pinch.id2)) return;
    const p1 = lastPointers.get(pinch.id1);
    const p2 = lastPointers.get(pinch.id2);
    const d = dist(p1,p2);
    const factor = d / pinch.d0;
    zoomAt(pinch.mid.x, pinch.mid.y, clamp(factor, 0.7, 1.3));
    pinch.d0 = d;
  });

  viewport.addEventListener('pointerup', (e)=> {
    lastPointers.delete(e.pointerId);
    if (e.pointerId === pinch.id1) pinch.id1 = null;
    if (e.pointerId === pinch.id2) pinch.id2 = null;
    if (!pinch.id1 || !pinch.id2) pinch.active = false;
  });

  function dist(a,b){ return Math.hypot(a.x-b.x,a.y-b.y); }

  // Mode connect
  let mode = 'normal';
  let pendingFrom = null;

  function setMode(m){
    mode = m;
    pendingFrom = null;
    document.getElementById('btnConnect').classList.toggle('active', mode==='connect');
    renderNodes();
    applyCam();
  }

  function pickNodeForLink(nodeId){
    if (!pendingFrom) {
      pendingFrom = nodeId;
      info.textContent = `MODALITÀ CONNETTI: scelto ${nodeId}. Ora clicca il secondo nodo.`;
      return;
    }
    if (pendingFrom === nodeId) return;

    const a = nodes.find(n=>n.id===pendingFrom);
    const b = nodes.find(n=>n.id===nodeId);
    const ac = nodeCenter(a);
    const bc = nodeCenter(b);
    const mid = { x:(ac.x+bc.x)/2, y:(ac.y+bc.y)/2 };
    const ctrl = { x: mid.x, y: mid.y - 120 };

    links.push({
      id: 'l' + Math.random().toString(16).slice(2),
      from: pendingFrom,
      to: nodeId,
      ctrl
    });

    pendingFrom = null;
    renderLinks();
    info.textContent = `Connettore creato. Trascina la maniglia per piegarlo.`;
  }

  // Add node helpers
  function addTextNode(){
    const n = {
      id: 'n' + Math.random().toString(16).slice(2),
      type: 'text',
      x: (Math.random()*520)-260,
      y: (Math.random()*420)-210,
      w: 280, h: 130,
      title: 'Nuovo nodo',
      subtitle: 'Sottotitolo',
      body: 'Contenuto…'
    };
    nodes.push(n);
    renderNodes();
    renderLinks();
    focusNode(n);
  }

  function addImageUrlNode(){
    const url = prompt("Incolla URL dell'immagine (https://...):");
    if (!url) return;

    const caption = prompt("Didascalia (facoltativa):") || '';
    const n = {
      id: 'n' + Math.random().toString(16).slice(2),
      type: 'image',
      x: (Math.random()*520)-260,
      y: (Math.random()*420)-210,
      w: 340, h: 240,
      title: 'Immagine',
      caption,
      src: url.trim()
    };
    nodes.push(n);
    renderNodes();
    renderLinks();
    focusNode(n);
  }

  function addImageUploadNode(file){
    const reader = new FileReader();
    reader.onload = () => {
      const dataUrl = reader.result; // base64
      const caption = prompt("Didascalia (facoltativa):") || '';
      const n = {
        id: 'n' + Math.random().toString(16).slice(2),
        type: 'image',
        x: (Math.random()*520)-260,
        y: (Math.random()*420)-210,
        w: 340, h: 240,
        title: file.name || 'Immagine',
        caption,
        src: dataUrl
      };
      nodes.push(n);
      renderNodes();
      renderLinks();
      focusNode(n);
      // Nota: se vuoi persistenza, qui potresti salvare nodes/links in localStorage.
    };
    reader.readAsDataURL(file);
  }

  // HUD
  document.getElementById('btnHome').onclick = home;
  document.getElementById('btnConnect').onclick = () => setMode(mode === 'connect' ? 'normal' : 'connect');
  document.getElementById('btnAddText').onclick = addTextNode;
  document.getElementById('btnAddImgUrl').onclick = addImageUrlNode;
  document.getElementById('btnAddImgUpload').onclick = () => fileInput.click();

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    addImageUploadNode(file);
    fileInput.value = '';
  });

  // Utils
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[s]));
  }
  function escapeAttr(str){
    // per attributo src
    return String(str).replace(/"/g, '&quot;');
  }

  // Init
  renderNodes();
  renderLinks();
  home();

})();
</script>
</body>
</html>
